general:
  artifacts:
    - ~/docs
    - ~/reports
machine:
  environment:
    PROJECT_TOP: ${HOME}/${CIRCLE_PROJECT_REPONAME}
    SDK_NAME: ${CIRCLE_PROJECT_REPONAME}
    SDK_TAG: ${CIRCLE_BRANCH}-${CIRCLE_BUILD_NUM}
    SDK_DOCS: ${HOME}/docs
    SDK_REPORTS: ${HOME}/reports
    SDK_COVERAGE_REPORTS: ${SDK_REPORTS}/coverage
    UNITTEST_REPORT: ${SDK_REPORTS}/unittests.html
    INTTEST_REPORT: ${SDK_REPORTS}/inttests.html
    RAW_REPORT: ${SDK_REPORTS}/raw.txt
    NUGET_NAME: Mbed.Cloud.SDK.1.2.7.nupkg
    ARTIFACTORY_URL: http://localhost:5000/artifactory/
    TESTRUNNER_DOCKER_IMAGE : 104059736540.dkr.ecr.us-west-2.amazonaws.com/mbed/sdk-testrunner:master
  services:
    - docker
checkout:
  post:
    - git config --global user.name monty-bot
    - git config --global user.email monty-bot@arm.com
    - aws s3 sync s3://artifactory-store ${PROJECT_TOP}
    - docker build -t artifactory . :
        pwd: proxy
    - |
      login="$(aws ecr get-login)"
      ${login}
      login="$(aws ecr get-login --no-include-email)"
      ${login}
dependencies:
  pre:
    - docker pull ${TESTRUNNER_DOCKER_IMAGE}
    - curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
    - sudo mv microsoft.gpg /etc/apt/trusted.gpg.d/microsoft.gpg
    - sudo sh -c 'echo "deb [arch=amd64] https://packages.microsoft.com/repos/microsoft-ubuntu-trusty-prod trusty main" > /etc/apt/sources.list.d/dotnetdev.list'
    - sudo apt-get update
    - sudo apt-get install dotnet-sdk-2.1.4
    # Add artful repo to get latest doxygen
    - sudo apt-get install software-properties-common python-software-properties
    - sudo add-apt-repository "deb http://archive.ubuntu.com/ubuntu/ artful main"
    - sudo apt-get update
    - sudo apt-get install doxygen
    - mkdir -p ${SDK_DOCS}
    - mkdir -p ${SDK_REPORTS}
    - mkdir -p ${SDK_COVERAGE_REPORTS}
  post:
    - npm install -g ansi-html-stream
compile:
  pre:
    - python scripts/dvcs_version.py
    - pip install -U git+https://github.com/davidhyman/towncrier.git@config-project-name
    - cd scripts && towncrier --yes --name="" --version=$(python dvcs_version.py version)
    - cp CHANGELOG.md ${CIRCLE_ARTIFACTS}/
  override:
    - dotnet build -c Release
    - dotnet pack MbedCloudSDK -c Release --no-build --no-restore
test:
  override:
    - echo "<h1>${SDK_NAME} Unit Tests (build ${CIRCLE_BUILD_NUM})</h1>" >> ${UNITTEST_REPORT}
    - dotnet test Tests/MbedCloudSDK.UnitTests -c Release --no-build --no-restore | ansi-html >> ${UNITTEST_REPORT}
    - cat ${UNITTEST_REPORT} | grep 'Total tests:' >> ${RAW_REPORT}
    - echo "<h1>${SDK_NAME} Integration Tests (build ${CIRCLE_BUILD_NUM})</h2>" >> ${INTTEST_REPORT}
    - set -o pipefail && bash scripts/test.sh 2>&1 | tee /dev/tty | ansi-html >> ${INTTEST_REPORT}
    - cat ${INTTEST_REPORT} | grep 'seconds ====' >> ${RAW_REPORT}
    - echo "finished"
  post:
    - docker run -d -p 5000:80 artifactory; sleep 10
deployment:
  master:
    branch: master
    commands:
      - ./scripts/generate-docs.sh
      - echo "Uploading to latest"
      - aws s3 sync --delete --cache-control max-age=3600 ${SDK_DOCS} s3://mbed-cloud-sdk-dotnet-dist/latest/docs
      - aws s3 sync --delete --cache-control max-age=3600 ${SDK_REPORTS} s3://mbed-cloud-sdk-dotnet-dist/latest/reports
      - dotnet nuget push MbedCloudSDK/bin/Release/${NUGET_NAME} -k ${ARTIFACTORY_API_KEY} -s ${ARTIFACTORY_URL}/api/nuget/mbed-cloud-sdk-dotnet-snapshots
  release:
    branch: /[0-9]+\.[0-9]+.*/
    commands:
      - echo Tagging $SDK_NAME in GitHub...
      - git tag ${SDK_TAG}
      - git push --tags
      - git add CHANGELOG.md news/* 
      - git commit -m ":newspaper: Hear yea, hear yea. News O'Clock. [skip ci]" 
      - git push 
      - dotnet nuget push MbedCloudSDK/bin/Release/${NUGET_NAME} -k ${NUGET_KEY} -s https://api.nuget.org/v3/index.json
