general:
  artifacts:
    - ~/docs
    - ~/tests
    - ~/tpip
    - ~/build
  branches:
    ignore:
      - build
machine:
  environment:
    SDK_NAME: ${CIRCLE_PROJECT_REPONAME}
    SDK_TAG: ${CIRCLE_BRANCH}-${CIRCLE_BUILD_NUM}
    SDK_DOCS: ${HOME}/docs
    SDK_TESTS: ${HOME}/tests
    SDK_TPIP: ${HOME}/tpip
    SDK_BUILD: ${HOME}/build
    NUGET_NAME: Mbed.Cloud.SDK.1.2.1.nupkg
checkout:
  post:
    - git config --global user.name alexl0gan
    - git config --global user.email alex.logan@arm.com
    - git clone https://github.com/ARMmbed/mbed-cloud-sdk-testrunner.git TestServer/testrunner
    - pip install -r TestServer/testrunner/requirements.txt
    - python setup.py develop:
        pwd: TestServer/testrunner
dependencies:
  pre:
    - sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 3FA7E0328081BFF6A14DA29AA6A19B38D3D831EF
    - echo "deb http://download.mono-project.com/repo/ubuntu trusty main" | sudo tee /etc/apt/sources.list.d/mono-official.list
    - sudo apt-get update
    - sudo apt-get install mono-devel
    - sudo apt-get install doxygen
    - mkdir ${SDK_DOCS}
    - mkdir ${SDK_TESTS}
    - mkdir ${SDK_TPIP}
    - mkdir ${SDK_BUILD}
  post:
    - npm install -g ansi-html-stream
    - ./scripts/setNugetCerts.sh
    - wget https://dist.nuget.org/win-x86-commandline/v2.8.6/nuget.exe
    - mono --runtime=v4.0 nuget.exe restore MbedCloudSDK/packages.config -PackagesDirectory packages
    - mono --runtime=v4.0 nuget.exe restore TestServer/packages.config -PackagesDirectory packages
compile:
  override:
    - msbuild /p:Configuration=Release | sed -r "s/\x1B\[([0-9]{1,2}(;[0-9]{1,2})?)?[mGK]//g"
    - rm nuget.exe
    - wget https://dist.nuget.org/win-x86-commandline/v4.3.0/nuget.exe
    - mono --runtime=v4.0 nuget.exe pack MbedCloudSDK/MbedCloudSDK.csproj -MSBuildPath "/usr/lib/mono/msbuild/15.0/bin" -IncludeReferencedProjects -Prop Configuration=Release -symbols | sed -r "s/\x1B\[([0-9]{1,2}(;[0-9]{1,2})?)?[mGK]//g"
    - mono --runtime=v4.0 nuget.exe sources Add -Name Artifactory -Source https://artifactory.mbed.com/artifactory/api/nuget/mbed-cloud-sdk-dotnet-local | sed -r "s/\x1B\[([0-9]{1,2}(;[0-9]{1,2})?)?[mGK]//g"
    - sudo mono --runtime=v4.0 nuget.exe setapikey alexl0gan:AKCp5Z3M3JdhgmQaY9TrroVTzvYhE93Nhg1Bo53KJ2RUbCW2U84c7pBVcbmsFhLcWsNFhUFNj -Source Artifactory | sed -r "s/\x1B\[([0-9]{1,2}(;[0-9]{1,2})?)?[mGK]//g"
    - mono --runtime=v4.0 nuget.exe push ${NUGET_NAME} -Source Artifactory | sed -r "s/\x1B\[([0-9]{1,2}(;[0-9]{1,2})?)?[mGK]//g"
    - mv ${NUGET_NAME} ${SDK_BUILD}
    - mv MbedCloudSDK/bin/Release/* ${SDK_BUILD}
test:
  override:
    - echo "<h1>${SDK_NAME} (build ${CIRCLE_BUILD_NUM})</h1>" > ${SDK_TESTS}/index.html:
    - set -o pipefail && bash scripts/test.sh 2>&1 | tee /dev/tty | ansi-html >> ${SDK_TESTS}/index.html:
    - mv MbedCloudSDK/tpip.csv ${SDK_TPIP}
    - echo "finished"
deployment:
  staging:
    branch: [master, /docs-.*/]
    commands:
      - ./scripts/generate-docs.sh
      - ./scripts/uploadArtifacts.sh
  release:
    branch: /[0-9]+\.[0-9]+.*/
    commands:
      - echo Tagging $SDK_NAME in GitHub...
      - git tag ${SDK_TAG}
      - git push --tags
      - ./scripts/uploadArtifacts.sh