general:
  artifacts:
    - ~/docs
    - ~/reports
machine:
  environment:
    PROJECT_TOP: ${HOME}/${CIRCLE_PROJECT_REPONAME}
    SDK_NAME: ${CIRCLE_PROJECT_REPONAME}
    SDK_TAG: ${CIRCLE_BRANCH}-${CIRCLE_BUILD_NUM}
    SDK_DOCS: ${HOME}/docs
    SDK_REPORTS: ${HOME}/reports
    SDK_COVERAGE_REPORTS: ${SDK_REPORTS}/coverage
    UNITTEST_REPORT: ${SDK_REPORTS}/unittests.html
    INTTEST_REPORT: ${SDK_REPORTS}/inttests.html
    RAW_REPORT: ${SDK_REPORTS}/raw.txt
    NUGET_NAME: Mbed.Cloud.SDK.1.2.3.nupkg
    ARTIFACTORY_URL: http://localhost:5000/artifactory/
    TESTRUNNER_DOCKER_IMAGE : 104059736540.dkr.ecr.us-west-2.amazonaws.com/mbed/sdk-testrunner:3126695136f9ce02d351b7f35564c6227a1b0bb8
  services:
    - docker
checkout:
  post:
      # switch out environment variables depending on branch
    - |
      if [[ $CIRCLE_BRANCH == build ]]; then
        echo export MBED_CLOUD_API_HOST='https://api.us-east-1.mbedcloud.com' >> $HOME/.circlerc;
        echo export MBED_CLOUD_API_KEY=$MBED_CLOUD_API_KEY_PROD >> $HOME/.circlerc;
        echo 'environment variables swapped';
      fi
    - git config --global user.name monty-bot
    - git config --global user.email monty-bot@arm.com
    - aws s3 sync s3://artifactory-store ${PROJECT_TOP}
    - docker build -t artifactory . :
        pwd: proxy
    - |
      login="$(aws ecr get-login)"
      ${login}
      login="$(aws ecr get-login --no-include-email)"
      ${login}
dependencies:
  pre:
    - docker pull ${TESTRUNNER_DOCKER_IMAGE}
    - curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
    - sudo mv microsoft.gpg /etc/apt/trusted.gpg.d/microsoft.gpg
    - sudo sh -c 'echo "deb [arch=amd64] https://packages.microsoft.com/repos/microsoft-ubuntu-trusty-prod trusty main" > /etc/apt/sources.list.d/dotnetdev.list'
    - sudo apt-get update
    - sudo apt-get install dotnet-sdk-2.1.4
    # Add artful repo to get latest doxygen
    - sudo apt-get install software-properties-common python-software-properties
    - sudo add-apt-repository "deb http://archive.ubuntu.com/ubuntu/ artful main"
    - sudo apt-get update
    - sudo apt-get install doxygen
    - mkdir -p ${SDK_DOCS}
    - mkdir -p ${SDK_REPORTS}
    - mkdir -p ${SDK_COVERAGE_REPORTS}
  post:
    - npm install -g ansi-html-stream
compile:
  override:
    - dotnet build -c Release
    - dotnet pack MbedCloudSDK -c Release --include-symbols --no-build --no-restore
test:
  override:
    - dotnet test Tests/MbedCloudSDK.UnitTests -c Release --no-build --no-restore
    - dotnet test Tests/MbedCloudSDK.ExampleTests -c Release --no-build --no-restore
    - ./scripts/test.sh