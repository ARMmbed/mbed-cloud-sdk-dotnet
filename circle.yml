general:
  artifacts:
    - ~/docs
machine:
  environment:
    SDK_TAG: ${CIRCLE_BRANCH}-${CIRCLE_BUILD_NUM}
    SDK_DOCS: ${HOME}/docs
dependencies:
  pre:
    - sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 3FA7E0328081BFF6A14DA29AA6A19B38D3D831EF
    - echo "deb http://download.mono-project.com/repo/ubuntu trusty main" | sudo tee /etc/apt/sources.list.d/mono-official.list
    - sudo apt-get update
    - sudo apt-get install mono-complete
    - sudo apt-get install doxygen
    - mkdir ${SDK_DOCS}
    - cp -r docs/* ${SDK_DOCS}/
test:
  override:
    - sh ./setNugetCerts.sh
    - wget https://dist.nuget.org/win-x86-commandline/v2.8.6/nuget.exe
    - mono --runtime=v4.0 nuget.exe restore MbedCloudSDK/packages.config -PackagesDirectory packages
    - mono --runtime=v4.0 nuget.exe restore TestServer/packages.config -PackagesDirectory packages
    - msbuild | sed -r "s/\x1B\[([0-9]{1,2}(;[0-9]{1,2})?)?[mGK]//g"
    - ./test.sh
    - echo "finished"
deployment:
  production:
    branch: master
    commands:
      - doxygen ar.doxygen
      - aws s3 sync --delete --cache-control max-age=3600 docs/ s3://mbed-cloud-sdk-dotnet-dist/${SDK-TAG}/docs