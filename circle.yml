general:
  artifacts:
    - ~/docs
    - ~/tests
    - ~/tpip
    - ~/build
machine:
  environment:
    SDK_NAME: ${CIRCLE_PROJECT_REPONAME}
    SDK_TAG: ${CIRCLE_BRANCH}-${CIRCLE_BUILD_NUM}
    SDK_DOCS: ${HOME}/docs
    SDK_TESTS: ${HOME}/tests
    SDK_TPIP: ${HOME}/tpip
    SDK_BUILD: ${HOME}/build
dependencies:
  pre:
    - sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 3FA7E0328081BFF6A14DA29AA6A19B38D3D831EF
    - echo "deb http://download.mono-project.com/repo/ubuntu trusty main" | sudo tee /etc/apt/sources.list.d/mono-official.list
    - sudo apt-get update
    - sudo apt-get install mono-devel
    - sudo apt-get install doxygen
    - mkdir ${SDK_DOCS}
    - mkdir ${SDK_TESTS}
    - mkdir ${SDK_TPIP}
    - mkdir ${SDK_BUILD}
test:
  pre:
    - npm install -g ansi-html-stream
    - sh ./setNugetCerts.sh
    - wget https://dist.nuget.org/win-x86-commandline/v2.8.6/nuget.exe
    - mono --runtime=v4.0 nuget.exe restore MbedCloudSDK/packages.config -PackagesDirectory packages
    - mono --runtime=v4.0 nuget.exe restore TestServer/packages.config -PackagesDirectory packages
    - msbuild /p:Configuration=Release | sed -r "s/\x1B\[([0-9]{1,2}(;[0-9]{1,2})?)?[mGK]//g"
  override:
    - mv MbedCloudSDK/bin/Release/* ${SDK_BUILD}
    - echo "<h1>${SDK_NAME} (build ${CIRCLE_BUILD_NUM})</h1>" > ${SDK_TESTS}/index.html:
    - ./test.sh
    - mv MbedCloudSDK/tpip.csv ${SDK_TPIP}
    - echo "finished"
deployment:
  production:
    branch: docs
    commands:
      - ./generate-docs.sh