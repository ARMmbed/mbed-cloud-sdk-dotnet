general:
  artifacts:
    - ~/docs
    - ~/tests
    - ~/tpip
    - ~/build
  branches:
    ignore:
      - build
machine:
  environment:
    SDK_NAME: ${CIRCLE_PROJECT_REPONAME}
    SDK_TAG: ${CIRCLE_BRANCH}-${CIRCLE_BUILD_NUM}
    SDK_DOCS: ${HOME}/docs
    SDK_TESTS: ${HOME}/tests
    SDK_TPIP: ${HOME}/tpip
    SDK_BUILD: ${HOME}/build
    NUGET_NAME: Mbed.Cloud.SDK.1.2.2.nupkg
checkout:
  post:
    - git config --global user.name monty-bot
    - git config --global user.email monty-bot@arm.com
    - git clone https://github.com/ARMmbed/mbed-cloud-sdk-testrunner.git TestServer/testrunner
    - pip install -r TestServer/testrunner/requirements.txt
    - python setup.py develop:
        pwd: TestServer/testrunner
dependencies:
  pre:
    - sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 3FA7E0328081BFF6A14DA29AA6A19B38D3D831EF
    - echo "deb http://download.mono-project.com/repo/ubuntu trusty main" | sudo tee /etc/apt/sources.list.d/mono-official.list
    - sudo apt-get update
    - sudo apt-get install mono-devel
    - sudo apt-get install doxygen
    - sudo apt-get install xsltproc
    - mkdir ${SDK_DOCS}
    - mkdir ${SDK_TESTS}
    - mkdir ${SDK_TPIP}
    - mkdir ${SDK_BUILD}
  post:
    - npm install -g ansi-html-stream
    - ./scripts/setNugetCerts.sh
    - wget https://dist.nuget.org/win-x86-commandline/v4.3.0/nuget.exe
    - mono --runtime=v4.0 nuget.exe restore MbedCloudSDK/packages.config -PackagesDirectory packages
    - mono --runtime=v4.0 nuget.exe restore TestServer/packages.config -PackagesDirectory packages
    - mono --runtime=v4.0 nuget.exe restore MbedCloudSDK.Test/packages.config -PackagesDirectory packages
compile:
  override:
    - msbuild /nologo /noconsolelogger MbedCloudSDK/MbedCloudSDK.csproj /p:Configuration=Release;RunCodeAnalysis=true;CodeAnalysisLogFile=AnalysisReport.xml | sed -r "s/\x1B\[([0-9]{1,2}(;[0-9]{1,2})?)?[mGK]//g"
    - msbuild /p:Configuration=Release | sed -r "s/\x1B\[([0-9]{1,2}(;[0-9]{1,2})?)?[mGK]//g"
    - mono --runtime=v4.0 nuget.exe pack MbedCloudSDK/MbedCloudSDK.csproj -MSBuildPath "/usr/lib/mono/msbuild/15.0/bin" -IncludeReferencedProjects -Prop Configuration=Release -symbols | sed -r "s/\x1B\[([0-9]{1,2}(;[0-9]{1,2})?)?[mGK]//g"
    - mv ${NUGET_NAME} ${SDK_BUILD}
    - mv MbedCloudSDK/bin/Release/* ${SDK_BUILD}
test:
  override:
    - echo "<h1>${SDK_NAME} (build ${CIRCLE_BUILD_NUM})</h1>" >> ${SDK_TESTS}/index.html:
    - echo "<h2>Unit Tests</h2>" >> ${SDK_TESTS}/index.html:
    - mono packages/NUnit.ConsoleRunner.3.7.0/tools/nunit3-console.exe MbedCloudSDK.Test/MbedCloudSDK.Test.csproj --config=Release | sed -r "s/\x1B\[([0-9]{1,2}(;[0-9]{1,2})?)?[mGK]//g"
    - xsltproc nunit3-junit.xslt TestResult.xml >> junit.xml
    - mkdir -p ${CIRCLE_TEST_REPORTS}/junit
    - cp junit.xml $CIRCLE_TEST_REPORTS/junit/test-results.xml
    - xsltproc html-report.xslt TestResult.xml | tee /dev/tty | ansi-html >> ${SDK_TESTS}/index.html:
    - echo "<h2>Integration Tests</h2>" >> ${SDK_TESTS}/index.html:
    - set -o pipefail && bash scripts/test.sh 2>&1 | tee /dev/tty | ansi-html >> ${SDK_TESTS}/index.html:
    - mv MbedCloudSDK/tpip.csv ${SDK_TPIP}
    - echo "finished"
deployment:
  staging:
    branch: [/docs-.*/, /feature-.*/]
    commands:
      - ./scripts/generate-docs.sh
      - ./scripts/uploadArtifacts.sh
  master:
    branch: master
    commands:
      - ./scripts/generate-docs.sh
      - ./scripts/uploadArtifactsMaster.sh
  release:
    branch: /[0-9]+\.[0-9]+.*/
    commands:
      - echo Tagging $SDK_NAME in GitHub...
      - git tag ${SDK_TAG}
      - git push --tags
      - ./scripts/uploadArtifacts.sh