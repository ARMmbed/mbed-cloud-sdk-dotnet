general:
  artifacts:
    - ~/docs
    - ~/tests
    - ~/tpip
    - ~/build
machine:
  environment:
    SDK_NAME: ${CIRCLE_PROJECT_REPONAME}
    SDK_TAG: ${CIRCLE_BRANCH}-${CIRCLE_BUILD_NUM}
    SDK_DOCS: ${HOME}/docs
    SDK_TESTS: ${HOME}/tests
    SDK_TPIP: ${HOME}/tpip
    SDK_BUILD: ${HOME}/build
    NUGET_NAME: Mbed.Cloud.SDK.1.2.1.nupkg
checkout:
  post:
    - git config --global user.name alexl0gan
    - git config --global user.email alex.logan@arm.com
    - git clone https://github.com/ARMmbed/mbed-cloud-sdk-testrunner.git TestServer/testrunner
    - pip install -r TestServer/testrunner/requirements.txt
    - python setup.py develop:
        pwd: TestServer/testrunner
dependencies:
  pre:
    - sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 3FA7E0328081BFF6A14DA29AA6A19B38D3D831EF
    - echo "deb http://download.mono-project.com/repo/ubuntu trusty main" | sudo tee /etc/apt/sources.list.d/mono-official.list
    - sudo apt-get update
    - sudo apt-get install mono-devel
    - sudo apt-get install doxygen
    - mkdir ${SDK_DOCS}
    - mkdir ${SDK_TESTS}
    - mkdir ${SDK_TPIP}
    - mkdir ${SDK_BUILD}
  post:
    - npm install -g ansi-html-stream
    - sh ./setNugetCerts.sh
    - wget https://dist.nuget.org/win-x86-commandline/v2.8.6/nuget.exe
    - mono --runtime=v4.0 nuget.exe restore MbedCloudSDK/packages.config -PackagesDirectory packages
    - mono --runtime=v4.0 nuget.exe restore TestServer/packages.config -PackagesDirectory packages
compile:
  override:
    - msbuild /p:Configuration=Release | sed -r "s/\x1B\[([0-9]{1,2}(;[0-9]{1,2})?)?[mGK]//g"
    - rm nuget.exe
    - wget https://dist.nuget.org/win-x86-commandline/v4.3.0/nuget.exe
    - mono --runtime=v4.0 nuget.exe pack MbedCloudSDK/MbedCloudSDK.csproj -MSBuildPath "/usr/lib/mono/msbuild/15.0/bin" -IncludeReferencedProjects -Prop Configuration=Release -symbols | sed -r "s/\x1B\[([0-9]{1,2}(;[0-9]{1,2})?)?[mGK]//g"
    - mv ${NUGET_NAME} ${SDK_BUILD}
    - mv MbedCloudSDK/bin/Release/* ${SDK_BUILD}
    - aws s3 sync --delete --cache-control max-age=3600 ${SDK_BUILD} s3://mbed-cloud-sdk-dotnet-dist/${SDK_TAG}/build
test:
  override:
    - echo "<h1>${SDK_NAME} (build ${CIRCLE_BUILD_NUM})</h1>" > ${SDK_TESTS}/index.html:
    - set -o pipefail && bash test.sh 2>&1 | tee /dev/tty | ansi-html >> ${SDK_TESTS}/index.html:
    - mv MbedCloudSDK/tpip.csv ${SDK_TPIP}
    - echo "finished"
deployment:
  production:
    branch: release-bits
    commands:
      - ./generate-docs.sh
      - aws s3 sync --delete --cache-control max-age=3600 ${SDK_DOCS} s3://mbed-cloud-sdk-dotnet-dist/${SDK_TAG}/docs
      - aws s3 sync --delete --cache-control max-age=3600 ${SDK_BUILD} s3://mbed-cloud-sdk-dotnet-dist/${SDK_TAG}/build
      - aws s3 sync --delete --cache-control max-age=3600 ${SDK_TESTS} s3://mbed-cloud-sdk-dotnet-dist/${SDK_TAG}/tests